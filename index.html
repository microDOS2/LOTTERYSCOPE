<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Lucky Lottery Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .celestial-gradient {
            background: linear-gradient(145deg, #012a20, #046c4e, #011a14);
        }
        .card-bg {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sign-card {
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .sign-card:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #34d399;
        }
        .sign-card.selected {
            background-color: rgba(52, 211, 153, 0.2);
            border-color: #34d399;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
        }
        /* New transition for hidden sections */
        .form-section {
            transition: opacity 0.5s ease-in-out, max-height 0.5s ease-in-out, transform 0.5s ease-in-out, margin-top 0.5s ease-in-out;
            max-height: 0;
            opacity: 0;
            transform: translateY(-1rem);
            overflow: hidden;
            margin-top: 0;
        }
        .form-section.visible {
            max-height: 1000px; /* Large enough for content */
            opacity: 1;
            transform: translateY(0);
            margin-top: 2rem; /* mb-8 */
        }
        #result-container {
            transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out;
        }
        input[type="date"], input[type="time"], select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        select option {
            background: #046c4e;
            color: white;
        }
        #results-list::-webkit-scrollbar { width: 8px; }
        #results-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        #results-list::-webkit-scrollbar-thumb { background: rgba(52, 211, 153, 0.5); border-radius: 10px; }
        #results-list::-webkit-scrollbar-thumb:hover { background: rgba(52, 211, 153, 0.8); }
        .day-panel-selected {
            border-color: #34d399 !important;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
        }
        input[type="checkbox"] { accent-color: #34d399; }
        .zodiac-svg { width: 40px; height: 40px; }
        .lottery-btn { transition: all 0.2s ease-in-out; }
        .lottery-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .video-cover {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .video-cover iframe {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 140%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
    </style>
</head>
<body class="celestial-gradient text-white min-h-screen flex items-center justify-center p-4">
    <main class="w-full max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2" style="color: rgb(211, 8, 49);">
                Cosmic Lucky Lottery Guide
            </h1>
            <p class="text-green-200 text-lg mb-4">Align your birth chart with the stars for ultimate luck!</p>
            <div class="video-cover w-full max-w-md mx-auto shadow-lg">
                <iframe 
                    src="https://www.youtube.com/embed/XxLRodQinJw?autoplay=1&mute=1&loop=1&playlist=XxLRodQinJw&controls=0&modestbranding=1&showinfo=0&rel=0" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>

        <!-- Step 1: Zodiac Sign Selector -->
        <h2 class="text-xl font-semibold text-green-300 mb-3 text-center">Step 1: Choose Your Sun Sign</h2>
        <div id="zodiac-selector" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 mb-8">
            <!-- Zodiac sign buttons will be injected here by JavaScript -->
        </div>

        <div id="form-container">
            <!-- Step 2: Birth Info -->
            <div id="birth-info" class="form-section card-bg p-6 rounded-2xl shadow-lg">
                 <h2 class="text-xl font-semibold text-green-300 mb-4 text-center">Step 2: Enter Your Birth Details</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="birthdate" class="block text-sm font-medium text-green-200 mb-1">Birthdate</label>
                        <input type="date" id="birthdate" name="birthdate" class="w-full p-2 rounded-md focus:ring-green-500 focus:border-green-500">
                        <p id="date-error" class="text-red-400 text-xs mt-1 h-3"></p>
                    </div>
                    <div>
                        <label for="birthtime" class="block text-sm font-medium text-green-200 mb-1">Time of Birth</label>
                        <input type="time" id="birthtime" name="birthtime" class="w-full p-2 rounded-md focus:ring-green-500 focus:border-green-500 transition-opacity">
                    </div>
                 </div>
                 <div class="mt-4">
                    <label for="birth-state" class="block text-sm font-medium text-green-200 mb-1">Place of Birth</label>
                    <select id="birth-state" name="birth-state" class="w-full p-2 rounded-md focus:ring-green-500 focus:border-green-500">
                    </select>
                </div>
                 <div class="mt-4">
                    <label for="birth-timezone" class="block text-sm font-medium text-green-200 mb-1">Birth Timezone</label>
                    <select id="birth-timezone" name="birth-timezone" class="w-full p-2 rounded-md focus:ring-green-500 focus:border-green-500">
                    </select>
                 </div>
                 <div class="mt-4 flex items-center">
                    <input type="checkbox" id="unknown-time" name="unknown-time" class="h-4 w-4 rounded">
                    <label for="unknown-time" class="ml-2 block text-sm text-green-200">Time of birth is unknown</label>
                </div>
            </div>

            <!-- Step 3: Current Location -->
            <div id="current-location" class="form-section card-bg p-6 rounded-2xl shadow-lg">
                 <h2 class="text-xl font-semibold text-green-300 mb-4 text-center">Step 3: Your Current Location</h2>
                 <div>
                    <label for="current-timezone" class="block text-sm font-medium text-green-200 mb-1">Current Timezone</label>
                    <select id="current-timezone" name="current-timezone" class="w-full p-2 rounded-md focus:ring-green-500 focus:border-green-500">
                    </select>
                 </div>
            </div>
            
            <!-- Step 4: Calculate Button -->
            <div id="calculate-section" class="form-section text-center">
                <button id="calculate-btn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Reveal My Lucky Times
                </button>
                <p id="error-message" class="text-red-400 mt-2 h-4"></p>
            </div>
        </div>

        <!-- Result Container -->
        <div id="result-container" class="card-bg p-6 rounded-2xl shadow-2xl opacity-0 transform scale-95 -translate-y-5 hidden">
            <h2 class="text-2xl font-semibold text-center mb-4 text-green-300">Your Auspicious Days</h2>
            <p class="text-center text-green-200 mb-6 -mt-2">Click a day below to choose your lottery game.</p>
            
            <div id="results-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 mb-6"></div>
            
            <div id="lottery-choice-container" class="my-6 text-center hidden border-t border-green-400/20 pt-6">
                <p class="text-green-200 mb-4 font-semibold">Choose your game to reveal numbers for the selected day:</p>
                <div class="flex justify-center items-center gap-3 flex-wrap">
                    <button data-lotto-type="powerball" class="lottery-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Powerball</button>
                    <button data-lotto-type="megamillions" class="lottery-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full">Mega Millions</button>
                    <button data-lotto-type="state" class="lottery-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">State Lottery</button>
                </div>
            </div>

            <div id="lucky-numbers-container" class="my-6 text-center hidden">
                <p id="lucky-numbers-title" class="text-green-200 mb-2">Your Lucky Numbers:</p>
                <div id="lucky-numbers" class="flex justify-center items-center gap-3 flex-wrap"></div>
            </div>

            <p class="text-sm text-green-300 italic text-center mt-6">"Fortune favors the astrologically aligned."</p>
        </div>
        
        <footer class="text-center mt-8 text-xs text-green-400">
            <p>Disclaimer: This app is for entertainment only and uses a simplified astrological model based on natal transit aspects. Please play responsibly.</p>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const zodiacSelector = document.getElementById('zodiac-selector');
            const birthInfoSection = document.getElementById('birth-info');
            const currentLocationSection = document.getElementById('current-location');
            const calculateSection = document.getElementById('calculate-section');

            const birthdateInput = document.getElementById('birthdate');
            const dateError = document.getElementById('date-error');
            const birthtimeInput = document.getElementById('birthtime');
            const birthStateInput = document.getElementById('birth-state');
            const birthTimezoneInput = document.getElementById('birth-timezone');
            const unknownTimeCheckbox = document.getElementById('unknown-time');
            const currentTimezoneInput = document.getElementById('current-timezone');
            const calculateBtn = document.getElementById('calculate-btn');
            const errorMessage = document.getElementById('error-message');

            const resultContainer = document.getElementById('result-container');
            const resultsList = document.getElementById('results-list');
            
            const lotteryChoiceContainer = document.getElementById('lottery-choice-container');
            const luckyNumbersContainer = document.getElementById('lucky-numbers-container');
            const luckyNumbersDisplay = document.getElementById('lucky-numbers');
            const luckyNumbersTitle = document.getElementById('lucky-numbers-title');

            let selectedSign = null;
            let currentNatalChart = null;
            let selectedDate = null;
            
            const iconColor = "#F8D000";

            const zodiacSigns = [
                { name: 'Aries', dateRange: "Mar 21 - Apr 19", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M25 75V50C25 25 75 25 75 50V75M50 100V40"/></svg>` },
                { name: 'Taurus', dateRange: "Apr 20 - May 20", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><circle cx="50" cy="60" r="25"/><path d="M35 35c10-20 30-20 40 0"/></svg>` },
                { name: 'Gemini', dateRange: "May 21 - Jun 20", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M25 25h50M25 75h50M40 25v50M60 25v50"/></svg>` },
                { name: 'Cancer', dateRange: "Jun 21 - Jul 22", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M30 35a20 20 0 1 0 40 0 20 20 0 1 0-40 0zM70 65a20 20 0 1 1-40 0 20 20 0 1 1 40 0z"/></svg>` },
                { name: 'Leo', dateRange: "Jul 23 - Aug 22", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><circle cx="40" cy="50" r="25"/><path d="M65 50c0 20 20 20 20-5V20"/></svg>` },
                { name: 'Virgo', dateRange: "Aug 23 - Sep 22", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M20 25v50M40 25v50M60 25v50l20-25c0-15-20-15-20 0z"/></svg>` },
                { name: 'Libra', dateRange: "Sep 23 - Oct 22", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M15 75h70M25 50a25 25 0 0 1 50 0"/></svg>` },
                { name: 'Scorpio', dateRange: "Oct 23 - Nov 21", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M20 25v50M40 25v50M60 25v25l25 25-10 10"/></svg>` },
                { name: 'Sagittarius', dateRange: "Nov 22 - Dec 21", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M20 80L80 20M50 20h30v30M20 50h30"/></svg>` },
                { name: 'Capricorn', dateRange: "Dec 22 - Jan 19", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M20 50v-25l30 25v25c0 15 25 15 25 0s-10-25-25-25"/></svg>` },
                { name: 'Aquarius', dateRange: "Jan 20 - Feb 18", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M20 35l15-15 15 15 15-15 15 15M20 65l15-15 15 15 15-15 15 15"/></svg>` },
                { name: 'Pisces', dateRange: "Feb 19 - Mar 20", svg: `<svg class="zodiac-svg" viewBox="0 0 100 100" fill="none" stroke="${iconColor}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"><path d="M25 20c-20 20 0 60 0 60M75 20c20 20 0 60 0 60M20 50h60"/></svg>` }
            ];
            
            const placesOfBirth = ["Alabama", "Alaska", "American Samoa", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "England", "Florida", "Georgia", "Guam", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Northern Ireland", "Northern Mariana Islands", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Puerto Rico", "Rhode Island", "Scotland", "South Carolina", "South Dakota", "Tennessee", "Texas", "U.S. Virgin Islands", "Utah", "Vermont", "Virginia", "Wales", "Washington", "West Virginia", "Wisconsin", "Wyoming"].sort();
            const timezones = [{ name: "Samoa Standard Time (SST)", value: "SST" }, { name: "Hawaii Standard Time (HST)", value: "HST" }, { name: "Alaska Standard Time (AKST)", value: "AKST" }, { name: "Pacific Standard Time (PST)", value: "PST" }, { name: "Mountain Standard Time (MST)", value: "MST" }, { name: "Central Standard Time (CST)", value: "CST" }, { name: "Eastern Standard Time (EST)", value: "EST" }, { name: "Atlantic Standard Time (AST)", value: "AST" }, { name: "Chamorro Standard Time (ChST)", value: "ChST" }, { name: "UK Time (GMT/BST)", value: "GMT" }];
            const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            function populateSelect(selectElement, options, placeholder) {
                selectElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = typeof opt === 'object' ? opt.value : opt;
                    option.textContent = typeof opt === 'object' ? opt.name : opt;
                    selectElement.appendChild(option);
                });
            }

            populateSelect(birthTimezoneInput, timezones, "Select a timezone");
            populateSelect(currentTimezoneInput, timezones, "Select a timezone");
            populateSelect(birthStateInput, placesOfBirth, "Select a Place of Birth");

            zodiacSigns.forEach((sign) => {
                const button = document.createElement('button');
                button.className = 'sign-card card-bg p-4 rounded-xl text-center';
                button.dataset.sign = sign.name;
                button.innerHTML = `${sign.svg}<span class="mt-2 text-sm font-semibold">${sign.name}</span>`;
                button.addEventListener('click', () => handleSignSelection(button, sign));
                zodiacSelector.appendChild(button);
            });

            function handleSignSelection(button, sign) {
                document.querySelectorAll('.sign-card').forEach(card => card.classList.remove('selected'));
                button.classList.add('selected');
                selectedSign = sign;
                
                // Reveal form sections
                [birthInfoSection, currentLocationSection, calculateSection].forEach(section => {
                    section.classList.add('visible');
                });

                validateDate();
            }

            function isDateInSignRange(date, sign) {
                if (!date || !sign) return false;
                const m = date.getMonth() + 1;
                const d = date.getDate();
                
                // Special handling for Capricorn which spans across the year-end
                if (sign.name === 'Capricorn') {
                    return (m === 12 && d >= 22) || (m === 1 && d <= 19);
                }

                // General case for other signs
                const [startMonthStr, startDayStr] = sign.dateRange.split(' - ')[0].split(' ');
                const [endMonthStr, endDayStr] = sign.dateRange.split(' - ')[1].split(' ');
                
                const startMonth = monthNames.findIndex(mn => mn.startsWith(startMonthStr)) + 1;
                const endMonth = monthNames.findIndex(mn => mn.startsWith(endMonthStr)) + 1;
                
                const startDate = new Date(2000, startMonth - 1, parseInt(startDayStr));
                const endDate = new Date(2000, endMonth - 1, parseInt(endDayStr));
                const checkDate = new Date(2000, m - 1, d);

                return checkDate >= startDate && checkDate <= endDate;
            }

            function validateDate() {
                if (!birthdateInput.value || !selectedSign) {
                    dateError.textContent = '';
                    return false;
                }
                const [year, month, day] = birthdateInput.value.split('-').map(Number);
                const date = new Date(year, month - 1, day);

                if (!isDateInSignRange(date, selectedSign)) {
                    dateError.textContent = `Please select a date for ${selectedSign.name} (${selectedSign.dateRange}).`;
                    return false;
                }
                dateError.textContent = '';
                return true;
            }
            
            birthdateInput.addEventListener('input', () => {
                validateDate();
                validateAllInputs();
            });

            unknownTimeCheckbox.addEventListener('input', () => {
                birthtimeInput.disabled = unknownTimeCheckbox.checked;
                birthtimeInput.classList.toggle('opacity-50', unknownTimeCheckbox.checked);
                if (unknownTimeCheckbox.checked) birthtimeInput.value = '';
                validateAllInputs();
            });

            function validateAllInputs() {
                const isTimeValid = birthtimeInput.value || unknownTimeCheckbox.checked;
                const isDateValid = validateDate();
                let isValid = selectedSign && birthdateInput.value && isDateValid && isTimeValid && birthStateInput.value && birthTimezoneInput.value && currentTimezoneInput.value;
                calculateBtn.disabled = !isValid;
                if(isValid) errorMessage.textContent = '';
                return isValid;
            }
            
            [birthtimeInput, birthStateInput, birthTimezoneInput, currentTimezoneInput].forEach(el => el.addEventListener('input', validateAllInputs));
            
            calculateBtn.addEventListener('click', () => {
                if(validateAllInputs()) {
                    calculateAndDisplayResults();
                } else {
                    errorMessage.textContent = 'Please complete all fields correctly.';
                }
            });

            // --- ASTROLOGICAL CALCULATION ENGINE ---

            function getPlanetaryPositions(date) {
                const totalHours = (date.getTime() / (1000 * 60 * 60)); 
                const totalDays = totalHours / 24;
                const totalYears = totalDays / 365.25;
                return {
                    Sun: (totalDays % 365.25) / 365.25 * 360, Moon: (totalHours * (13.176 / 24)) % 360,
                    Mercury: (totalDays % 88) / 88 * 360, Venus: (totalDays % 225) / 225 * 360,
                    Mars: (totalDays % 687) / 687 * 360, Jupiter: (totalYears % 11.86) / 11.86 * 360,
                    Saturn: (totalYears % 29.46) / 29.46 * 360,
                };
            }
            
            function getAspect(pos1, pos2) {
                const diff = Math.abs(pos1 - pos2);
                const orb = 8; 
                if (Math.abs(diff - 120) < orb || Math.abs(diff - 240) < orb) return { type: "Trine", points: 5 };
                if (Math.abs(diff - 60) < orb || Math.abs(diff - 300) < orb) return { type: "Sextile", points: 3 };
                if (Math.abs(diff - 90) < orb || Math.abs(diff - 270) < orb) return { type: "Square", points: -4 };
                if (Math.abs(diff - 180) < orb) return { type: "Opposition", points: -5 };
                return null; 
            }

            function findAuspiciousDays(natalChart, startDate) {
                const luckyDays = {};
                let checkDate = new Date(startDate);

                const natalPlanets = {'Sun': natalChart.Sun, 'Moon': natalChart.Moon, 'Mercury': natalChart.Mercury, 'Venus': natalChart.Venus, 'Jupiter': natalChart.Jupiter};
                const MAJOR_TRANSITORS = ['Jupiter', 'Venus'];
                const MINOR_TRANSITORS = ['Sun', 'Mercury', 'Moon'];
                const LUCKY_NATAL_TARGETS = ['Sun', 'Moon', 'Venus', 'Jupiter'];

                for (let i = 0; i < 24 * 180; i++) { 
                    const dayKey = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
                    if (!luckyDays[dayKey]) {
                        luckyDays[dayKey] = { date: new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate()), majorTransits: new Set(), minorTransits: new Set(), isDisqualified: false, };
                    }
                    if (luckyDays[dayKey].isDisqualified) { checkDate.setHours(checkDate.getHours() + 1); continue; }
                    const transitingPlanets = getPlanetaryPositions(checkDate);
                    const challengingPlanets = ['Mars', 'Saturn'];
                    const personalPlanets = ['Sun', 'Moon', 'Venus', 'Mercury'];
                    for (const tPlanetName of challengingPlanets) {
                        for (const nPlanetName of personalPlanets) {
                            if (natalChart[nPlanetName] === undefined) continue;
                            const aspect = getAspect(transitingPlanets[tPlanetName], natalChart[nPlanetName]);
                            if (aspect && aspect.points < 0) { luckyDays[dayKey].isDisqualified = true; break; }
                        }
                        if (luckyDays[dayKey].isDisqualified) break;
                    }
                    if (luckyDays[dayKey].isDisqualified) { checkDate.setHours(checkDate.getHours() + 1); continue; }
                    for (const [tPlanetName, tPos] of Object.entries(transitingPlanets)) {
                        for (const [nPlanetName, nPos] of Object.entries(natalPlanets)) {
                             const aspect = getAspect(tPos, nPos);
                             if (aspect && aspect.points > 0) {
                                const reason = `${tPlanetName} ${aspect.type} your natal ${nPlanetName}`;
                                if(MAJOR_TRANSITORS.includes(tPlanetName) && LUCKY_NATAL_TARGETS.includes(nPlanetName)) { luckyDays[dayKey].majorTransits.add(reason); } 
                                else if (MINOR_TRANSITORS.includes(tPlanetName)) { luckyDays[dayKey].minorTransits.add(reason); }
                             }
                        }
                    }
                    checkDate.setHours(checkDate.getHours() + 1);
                }
                const validLuckyDays = Object.values(luckyDays).filter(day => !day.isDisqualified && (day.majorTransits.size > 0 || day.minorTransits.size > 2));
                return validLuckyDays.sort((a, b) => {
                    if (b.majorTransits.size !== a.majorTransits.size) { return b.majorTransits.size - a.majorTransits.size; }
                    const bHasJupiter = Array.from(b.majorTransits).some(t => t.startsWith('Jupiter'));
                    const aHasJupiter = Array.from(a.majorTransits).some(t => t.startsWith('Jupiter'));
                    if (bHasJupiter && !aHasJupiter) return -1;
                    if (!bHasJupiter && aHasJupiter) return 1;
                    return b.minorTransits.size - a.minorTransits.size;
                });
            }

            function calculateAndDisplayResults() {
                calculateBtn.textContent = 'Calculating Cosmos...';
                calculateBtn.disabled = true;

                setTimeout(() => {
                    const birthTimeValue = unknownTimeCheckbox.checked ? '12:00' : birthtimeInput.value;
                    const [year, month, day] = birthdateInput.value.split('-');
                    const [hour, minute] = birthTimeValue.split(':');
                    const birthDate = new Date(year, month - 1, day, hour, minute);
                    
                    currentNatalChart = getPlanetaryPositions(birthDate);
                    const allDays = findAuspiciousDays(currentNatalChart, new Date());
                    
                    resultsList.innerHTML = ''; 
                    lotteryChoiceContainer.classList.add('hidden');
                    luckyNumbersContainer.classList.add('hidden');

                    if(allDays.length === 0) {
                        resultsList.innerHTML = `<div class="text-center p-4 text-green-200">No qualifying lucky days found in the next 180 days.</div>`;
                    } else {
                        const daysByMonth = {};
                        allDays.forEach(day => {
                            const key = `${day.date.getFullYear()}-${day.date.getMonth()}`;
                            if (!daysByMonth[key]) daysByMonth[key] = [];
                            if (daysByMonth[key].length < 3) daysByMonth[key].push(day);
                        });

                        const sortedMonths = Object.keys(daysByMonth).sort((a,b) => new Date(a.split('-')[0], a.split('-')[1]) - new Date(b.split('-')[0], b.split('-')[1]));
                        const overallBestDay = allDays[0];

                        sortedMonths.forEach(monthKey => {
                            const [year, month] = monthKey.split('-').map(Number);
                            const header = document.createElement('h3');
                            header.className = 'text-xl font-bold text-green-300 pt-4 first:pt-0';
                            header.textContent = `${monthNames[month]} ${year}`;
                            resultsList.appendChild(header);

                            daysByMonth[monthKey].forEach(day => {
                                const item = document.createElement('div');
                                const isMostFavorable = day.date.getTime() === overallBestDay.date.getTime();
                                const dateString = `${daysOfWeek[day.date.getDay()]}, ${monthNames[day.date.getMonth()]} ${day.date.getDate()}`;
                                
                                item.className = `day-panel p-4 rounded-lg border transition-colors mt-2 cursor-pointer ${isMostFavorable ? 'bg-green-600/20 border-green-500' : 'bg-white/5 border-transparent hover:border-green-600/50'}`;
                                
                                let content = '';
                                if(isMostFavorable) content += `<span class="inline-block bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full mb-2">Most Favorable Day</span>`;
                                content += `<p class="font-bold text-lg ${isMostFavorable ? 'text-white' : 'text-green-200'}">${dateString}</p>`;
                                if (day.majorTransits.size > 0) {
                                    content += `<p class="text-sm text-green-300 mt-2 font-semibold">Major Influences:</p><ul class="list-disc list-inside text-sm text-green-300">`;
                                    Array.from(day.majorTransits).forEach(transit => { content += `<li>${transit}</li>`; });
                                    content += `</ul>`;
                                }
                                if (day.minorTransits.size > 0) {
                                     content += `<p class="text-sm text-green-300 mt-2 font-semibold">Supporting Influences:</p><ul class="list-disc list-inside text-sm text-green-300">`;
                                     Array.from(day.minorTransits).forEach(transit => { content += `<li>${transit}</li>`; });
                                     content += `</ul>`;
                                }
                                item.innerHTML = content;
                                item.addEventListener('click', () => {
                                    document.querySelectorAll('.day-panel').forEach(panel => panel.classList.remove('day-panel-selected'));
                                    item.classList.add('day-panel-selected');
                                    selectedDate = day.date;
                                    luckyNumbersContainer.classList.add('hidden');
                                    lotteryChoiceContainer.classList.remove('hidden');
                                    lotteryChoiceContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                });
                                resultsList.appendChild(item);
                            });
                        });
                    }
                    resultContainer.classList.remove('hidden');
                    setTimeout(() => resultContainer.classList.remove('opacity-0', 'scale-95', '-translate-y-5'), 10);
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    calculateBtn.textContent = 'Reveal My Lucky Times';
                    validateAllInputs();
                }, 100); 
            }

            lotteryChoiceContainer.addEventListener('click', (e) => {
                if(e.target.matches('[data-lotto-type]')) {
                    const lotteryType = e.target.dataset.lottoType;
                    const luckyNumbers = generateLuckyNumbers(currentNatalChart, selectedDate, lotteryType);
                    displayLuckyNumbers(luckyNumbers, lotteryType);
                }
            });

            function displayLuckyNumbers(numbers, type) {
                luckyNumbersDisplay.innerHTML = '';
                const dateString = `${monthNames[selectedDate.getMonth()]} ${selectedDate.getDate()}, ${selectedDate.getFullYear()}`;
                luckyNumbersTitle.textContent = `Your Lucky Numbers for ${dateString}:`;

                let specialBallClass = 'bg-emerald-500/70';
                if (type === 'powerball') specialBallClass = 'bg-red-600/70';
                if (type === 'megamillions') specialBallClass = 'bg-purple-600/70';

                numbers.forEach((num, index) => {
                    const numberEl = document.createElement('div');
                    const isSpecialBall = (type === 'powerball' || type === 'megamillions') && index === numbers.length - 1;
                    
                    numberEl.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${isSpecialBall ? specialBallClass : 'bg-green-500/50'}`;
                    numberEl.textContent = num;
                    luckyNumbersDisplay.appendChild(numberEl);
                });
                
                luckyNumbersContainer.classList.remove('hidden');
                luckyNumbersContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function generateLuckyNumbers(natalChart, drawDate, lotteryType) {
                const transitingPlanets = getPlanetaryPositions(drawDate);
                const natalValues = Object.values( natalChart );
                const transitingValues = Object.values(transitingPlanets);
                const mainNumbers = new Set();
                let mainPool, specialPool, mainCount;

                switch(lotteryType) {
                    case 'powerball': mainPool = 69; specialPool = 26; mainCount = 5; break;
                    case 'megamillions': mainPool = 70; specialPool = 25; mainCount = 5; break;
                    case 'state': default: mainPool = 49; specialPool = 0; mainCount = 6; break;
                }

                for(let i = 0; i < natalValues.length; i++) {
                    if(mainNumbers.size < mainCount) {
                        const combination = natalValues[i] + transitingValues[(i + 3) % transitingValues.length];
                        const newNum = Math.floor(((combination % mainPool) + mainPool) % mainPool) + 1;
                        if (!mainNumbers.has(newNum)) mainNumbers.add(newNum);
                    }
                }
                
                let safetyCounter = 0;
                while(mainNumbers.size < mainCount && safetyCounter < 50) {
                     const extraNum = Math.floor((((natalValues[safetyCounter % natalValues.length] + transitingValues[safetyCounter % transitingValues.length] + safetyCounter) % mainPool) + mainPool) % mainPool) + 1;
                     if (!mainNumbers.has(extraNum)) mainNumbers.add(extraNum);
                     safetyCounter++;
                }
                
                const sortedNumbers = Array.from(mainNumbers).sort((a,b) => a-b);

                if (specialPool > 0) {
                    const powerballSeed = natalValues.reduce((s, d) => s + d, 0) + transitingValues.reduce((s, d) => s + d, 0);
                    const powerball = Math.floor(((powerballSeed % specialPool) + specialPool) % specialPool) + 1;
                    sortedNumbers.push(powerball);
                }
                
                return sortedNumbers;
            }
        });
    </script>
</body>
</html>

